##############################################################################
#
# Library:   TubeTK
#
# Copyright, Kitware Inc. 28 Corporate Drive,
# Clifton Park, NY, 12065, USA.
#
# All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#       http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
##############################################################################


#########################################################################
# Source Setup
#########################################################################
branches:
 only:
  - master

version: "0.0.1.{build}"


#########################################################################
# Machine Setup
#########################################################################
os:
  - Visual Studio 2015

environment:
  matrix:
    - MINICONDA: "C:\\Miniconda36-x64"
  
configuration:
  - Release

########################################################################
# Build and test ITKModule 
########################################################################

####
# Begin installation
####
install:

  ####
  # Setup the environment
  ####
  - call "C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\vcvarsall.bat" amd64
  - "set PATH=%MINICONDA%;%MINICONDA%\\Scripts;%MINICONDA%\\Library\\bin;%PATH%"
  - "set ITK_RELEASE_URL=https://data.kitware.com/api/v1/item/5c191abc8d777f072bd9231a/download"
  - "set ITK_RELEASE_ZIP=C:\\projects\\deps\\ITK-Release.zip"
  - "set ITK_DIR=C:\\projects\\deps\\ITK-Release"
  - "set VTK_INSTALL_URL=https://data.kitware.com/api/v1/item/5c18d4a18d777f072bd842bb/download"
  - "set VTK_INSTALL_ZIP=C:\\projects\\deps\\VTK-Install.zip"
  - "set VTK_DIR=C:\\projects\\deps\\VTK-Install\\lib\\cmake\\vtk-8.1"
  - "set SlicerExecutionModel_RELEASE_URL=https://data.kitware.com/api/v1/item/5c190cc98d777f072bd91355/download"
  - "set SlicerExecutionModel_RELEASE_ZIP=C:\\projects\\deps\\SlicerExecutionModel-Release.zip"
  - "set SlicerExecutionModel_DIR=C:\\projects\\deps\\SlicerExecutionModel-Release"
  - conda config --set always_yes yes --set changeps1 no
  - conda config --add channels conda-forge
  - conda install numpy scipy ninja
  - ninja --version
  - cmake --version

  ####
  # Setup the dependencies
  ####
  - IF NOT EXIST C:\projects\deps mkdir C:\projects\deps
  - cd C:\projects\deps
  
  ####
  # Install ITK
  ####
  - IF NOT EXIST %ITK_RELEASE_ZIP% (
      appveyor DownloadFile %ITK_RELEASE_URL% -FileName %ITK_RELEASE_ZIP% 
      )
  - IF NOT EXIST %ITK_DIR% ( 7z x %ITK_RELEASE_ZIP% > null )

  ####
  # Install VTK
  ####
  - IF NOT EXIST %VTK_INSTALL_ZIP% (
      appveyor DownloadFile %VTK_INSTALL_URL% -FileName %VTK_INSTALL_ZIP% 
      )
  - IF NOT EXIST %VTK_DIR% ( 7z x %VTK_INSTALL_ZIP% > null )

  ####
  # Install SlicerExecutionModel
  ####
  - IF NOT EXIST %SlicerExecutionModel_RELEASE_ZIP% (
      appveyor DownloadFile %SlicerExecutionModel_RELEASE_URL% -FileName %SlicerExecutionModel_RELEASE_ZIP% 
      )
  - IF NOT EXIST %SlicerExecutionModel_DIR% (
      7z x %SlicerExecutionModel_RELEASE_ZIP% > null
      )

#####################################################################
# Build
#####################################################################
build:
  verbosity: detailed
  
build_script:
  - cd C:\projects
  - mkdir ITKTubeTK-Release
  - cd ITKTubeTK-Release
  - cmake -GNinja -DITK_DIR=%ITK_DIR% -DVTK_DIR=%VTK_DIR% -DSlicerExecutionModel_DIR=%SlicerExecutionModel_DIR% -DCMAKE_BUILD_TYPE=Release ..\ITKTubeTK
  - ninja
 
#####################################################################
# Test Script
#####################################################################
test_script:
  - cd C:\projects\ITKTubeTK-Release
  - ctest -D Experimental
 
 
#########################################################################
# Archive
#########################################################################
#artifacts:
# pushing entire folder as a zip archive
#- path: dist\*

deploy: off
